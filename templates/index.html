<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Awareness - Network Discovery</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --accent-primary: #3b82f6;
      --accent-secondary: #8b5cf6;
      --accent-success: #10b981;
      --border-color: #334155;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
    }

    /* Header */
    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px var(--shadow);
      z-index: 100;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .controls {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .control-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    select {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 150px;
    }

    select:hover {
      border-color: var(--accent-primary);
      background: var(--bg-secondary);
    }

    select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Main Layout */
    .container {
      display: flex;
      height: calc(100vh - 73px);
    }

    /* Sidebar */
    .sidebar {
      width: 380px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      padding: 1.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .card {
      background: var(--bg-tertiary);
      border-radius: 0.75rem;
      padding: 1.25rem;
      border: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 2rem;
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    input[type="text"] {
      flex: 1;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    button {
      background: var(--accent-primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    button:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
    }

    button.secondary:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
      box-shadow: none;
    }

    .list-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      padding: 0.5rem;
      max-height: 120px;
      overflow-y: auto;
      margin-bottom: 0.5rem;
    }

    .list-item {
      padding: 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-family: 'Monaco', 'Courier New', monospace;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text-secondary);
    }

    .list-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .list-item:active {
      background: var(--accent-primary);
      color: white;
    }

    .section {
      margin-bottom: 1rem;
    }

    .section:last-child {
      margin-bottom: 0;
    }

    /* Graph Container */
    #graph-container {
      flex: 1;
      position: relative;
      background: var(--bg-primary);
    }

    #cy {
      width: 100%;
      height: 100%;
    }

    /* Stats Badge */
    .stats {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .stat-badge {
      background: var(--bg-primary);
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .stat-number {
      color: var(--accent-primary);
      font-weight: 600;
    }

    /* Auto-refresh indicator */
    .refresh-indicator {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 50;
    }

    .pulse {
      width: 8px;
      height: 8px;
      background: var(--accent-success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-color);
    }

    /* Empty state */
    .empty-state {
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-style: italic;
      padding: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">âš¡ Awareness</div>
    <div class="controls">
      <div class="control-group">
        <label class="control-label">Endpoint</label>
        <select id="nodeSelector" onchange="selectNode(this.value)" autofocus>
          {% for node in dropdown_endpoints %}
          <option value="{{ node }}" {% if node == selected_node %}selected{% endif %}>{{ node }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="control-group">
        <label class="control-label">Time Range</label>
        <select id="scanInterval" onchange="selectScanInterval(this.value)">
          <option value="5" {% if scan_interval == 5 %}selected{% endif %}>5 Minutes</option>
          <option value="15" {% if scan_interval == 15 %}selected{% endif %}>15 Minutes</option>
          <option value="30" {% if scan_interval == 30 %}selected{% endif %}>30 Minutes</option>
          <option value="60" {% if scan_interval == 60 %}selected{% endif %}>1 Hour</option>
          <option value="240" {% if scan_interval == 240 %}selected{% endif %}>4 Hours</option>
          <option value="1440" {% if scan_interval == 1440 %}selected{% endif %}>1 Day</option>
        </select>
      </div>
      <div class="control-group">
        <label class="control-label">Auto-Refresh</label>
        <select id="refreshInterval" onchange="updateRefreshInterval(this.value)">
          <option value="0">Off</option>
          <option value="3">3 seconds</option>
          <option value="5" selected>5 seconds</option>
          <option value="10">10 seconds</option>
          <option value="30">30 seconds</option>
          <option value="60">1 minute</option>
        </select>
      </div>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div class="card">
        <div class="card-title">Endpoint Details</div>
        <div class="input-group">
          <input name="endpoint_name" type="text" value="{{ endpoint }}" placeholder="Endpoint name">
          <button onclick="updateEndpointName()">Update</button>
        </div>
        <div class="stats">
          <div class="stat-badge">IPs: <span class="stat-number">{{ ips|length }}</span></div>
          <div class="stat-badge">MACs: <span class="stat-number">{{ macs|length }}</span></div>
          <div class="stat-badge">Hosts: <span class="stat-number">{{ hostnames|length }}</span></div>
          <div class="stat-badge">Protocols: <span class="stat-number">{{ protocols|length }}</span></div>
        </div>
      </div>

      <div class="card">
        <div class="section">
          <div class="card-title">MAC Addresses</div>
          <div class="list-box" id="macs-container">
            {% if macs %}
              {% for mac in macs %}
              <div class="list-item" onclick="copyToClipboard('{{ mac }}', this)">{{ mac }}</div>
              {% endfor %}
            {% else %}
              <div class="empty-state">No MAC addresses</div>
            {% endif %}
          </div>
        </div>

        <div class="section">
          <div class="card-title">Hostnames</div>
          <div class="list-box" id="hostnames-container">
            {% if hostnames %}
              {% for hostname in hostnames %}
              <div class="list-item" onclick="copyToClipboard('{{ hostname }}', this)">{{ hostname }}</div>
              {% endfor %}
            {% else %}
              <div class="empty-state">No hostnames</div>
            {% endif %}
          </div>
        </div>

        <div class="section">
          <div class="card-title">IP Addresses</div>
          <div class="list-box" id="ips-container">
            {% if ips %}
              {% for ip in ips %}
              <div class="list-item" onclick="copyToClipboard('{{ ip }}', this)">{{ ip }}</div>
              {% endfor %}
            {% else %}
              <div class="empty-state">No IP addresses</div>
            {% endif %}
          </div>
        </div>

        <div class="section">
          <div class="card-title">Protocols</div>
          <div class="list-box" id="protocols-container">
            {% if protocols %}
              {% for protocol in protocols %}
              <div class="list-item" onclick="copyToClipboard('{{ protocol }}', this)">{{ protocol }}</div>
              {% endfor %}
            {% else %}
              <div class="empty-state">No protocols</div>
            {% endif %}
          </div>
        </div>
      </div>
    </aside>

    <main id="graph-container">
      <div id="cy"></div>
    </main>
  </div>

  <div class="refresh-indicator">
    <div class="pulse"></div>
    <span>Live monitoring</span>
  </div>

  <script>
    // Navigation functions
    function selectNode(nodeId) {
      const url = new URL(window.location.href);
      url.searchParams.set('node', nodeId);
      window.location.href = url.toString();
    }

    function selectScanInterval(interval) {
      const url = new URL(window.location.href);
      url.searchParams.set('scan_interval', interval);
      window.location.href = url.toString();
    }

    // Copy to clipboard with visual feedback
    function copyToClipboard(text, element) {
      navigator.clipboard.writeText(text).then(() => {
        const originalBg = element.style.background;
        element.style.background = 'var(--accent-success)';
        element.style.color = 'white';
        setTimeout(() => {
          element.style.background = originalBg;
          element.style.color = '';
        }, 500);
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    }

    // Update endpoint name
    function updateEndpointName() {
      const endpointNameInput = document.querySelector('input[name="endpoint_name"]');
      const newHostname = endpointNameInput.value;
      const currentHostname = "{{ endpoint }}";

      fetch(`/update_endpoint?hostname=${encodeURIComponent(currentHostname)}&new_hostname=${encodeURIComponent(newHostname)}`, {
        method: 'GET',
      })
      .then(response => {
        if (response.ok) {
          const url = new URL(window.location.href);
          url.searchParams.set('node', newHostname);
          window.location.href = url.toString();
        } else {
          alert('Failed to update endpoint name.');
        }
      })
      .catch(error => {
        console.error('Error updating endpoint name:', error);
        alert('An error occurred while updating the endpoint name.');
      });
    }

    // Initialize Cytoscape graph
    var cy = cytoscape({
      container: document.getElementById('cy'),
      boxSelectionEnabled: false,
      autounselectify: true,
      layout: {
        name: 'cose',
        nodeRepulsion: 400000,
        nodeDimensionsIncludeLabels: true,
        padding: 80,
        animate: true,
        animationDuration: 500
      },
      elements: [
        {% for endpoint in endpoints %}
          { data: {
              id: '{{ endpoint }}',
              {% if endpoint == hostname %}type: 'local'
              {% elif endpoint == selected_node %}type: 'selected'{% endif %}
            }
          },
        {% endfor %}
        {% for comm in communications %}
          { data: {
            id: '{{ comm.sub_protocol }}-{{ comm.src_hostname }}-{{ comm.dst_hostname }}',
            source: '{{ comm.src_hostname }}',
            target: '{{ comm.dst_hostname }}',
            label: '{{ comm.sub_protocol }}'
          }},
        {% endfor %}
      ],
      style: [
        {
          selector: 'node',
          style: {
            'label': function(ele) { return 'ðŸ’»\n' + ele.data('id'); },
            'shape': 'round-rectangle',
            'background-color': '#1e293b',
            'font-size': 11,
            'font-weight': 600,
            'text-valign': 'center',
            'text-halign': 'center',
            'text-wrap': 'wrap',
            'text-max-width': '120px',
            'text-outline-width': 2,
            'text-outline-color': '#0f172a',
            'color': '#f1f5f9',
            'width': 60,
            'height': 60,
            'border-width': 2,
            'border-color': '#3b82f6'
          }
        },
        {
          selector: 'node[type = "local"]',
          style: {
            'label': function(ele) { return 'ðŸ–¥ï¸\n' + ele.data('id'); },
            'border-color': '#8b5cf6',
            'border-width': 3
          }
        },
        {
          selector: 'node[type = "selected"]',
          style: {
            'border-width': 4,
            'border-color': '#10b981'
          }
        },
        {
          selector: 'edge',
          style: {
            'target-arrow-shape': 'triangle',
            'label': 'data(label)',
            'curve-style': 'bezier',
            'width': 1.5,
            'opacity': 0.4,
            'line-color': '#475569',
            'target-arrow-color': '#475569',
            'font-size': 0,
            'color': '#94a3b8',
            'text-outline-width': 2,
            'text-outline-color': '#0f172a'
          }
        },
        {
          selector: 'edge:selected',
          style: {
            'font-size': 9,
            'opacity': 0.8,
            'width': 2
          }
        }
      ],
    });

    // Node click handler
    cy.on('tap', 'node', function(event) {
      var nodeId = event.target.id();
      var currentUrl = new URL(window.location.href);
      var currentNodeParam = currentUrl.searchParams.get('node');

      if (currentNodeParam !== nodeId) {
        currentUrl.searchParams.set('node', nodeId);
        window.location.href = currentUrl.toString();
      }
    });

    // Auto-refresh management
    let refreshIntervalId = null;

    function updateRefreshInterval(seconds) {
      // Save preference
      localStorage.setItem('refreshInterval', seconds);

      // Clear existing interval
      if (refreshIntervalId) {
        clearInterval(refreshIntervalId);
        refreshIntervalId = null;
      }

      // Update indicator
      const indicator = document.querySelector('.refresh-indicator span');
      const pulse = document.querySelector('.pulse');

      if (seconds == 0) {
        indicator.textContent = 'Auto-refresh disabled';
        pulse.style.display = 'none';
      } else {
        indicator.textContent = `Refreshing every ${seconds}s`;
        pulse.style.display = 'block';

        // Set new interval
        refreshIntervalId = setInterval(() => {
          window.location.reload();
        }, seconds * 1000);
      }
    }

    // Initialize refresh interval on page load
    window.addEventListener('DOMContentLoaded', () => {
      const savedInterval = localStorage.getItem('refreshInterval') || '5';
      document.getElementById('refreshInterval').value = savedInterval;
      updateRefreshInterval(savedInterval);
    });
  </script>
</body>
</html>
